<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Oh my Goss - Townhall</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <link href="https://fonts.googleapis.com/css2?family=Archivo:ital,wdth,wght@0,100..900;1,100..900&family=JetBrains+Mono:wght@400;500;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Premium Panic Palette (From Index) */
      --bg-gradient-start: #FFB300; /* Amber Warning */
      --bg-gradient-end: #FF3D00;   /* Deep Orange */
      --accent: #D50000;            /* Alarm Red */
      --ink: #121212;               /* Soft Black */
      --paper: #F4F1EA;             /* Archival Paper */
      --paper-shadow: #BEBDB8;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      margin: 0; padding: 0;
    }

    body {
      background-color: var(--bg-gradient-start);
      background-image: linear-gradient(145deg, var(--bg-gradient-start), var(--bg-gradient-end));
      color: var(--ink);
      font-family: "JetBrains Mono", monospace;
      min-height: 100vh;
      width: 100vw;
      overflow-x: hidden;
      padding-bottom: 180px; /* Space for composer */
    }

    /* --- ATMOSPHERE --- */
    .grain {
      position: fixed; inset: 0; pointer-events: none; z-index: 2; opacity: 0.12;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    }
    .vignette {
      position: fixed; inset: 0; pointer-events: none; z-index: 3;
      background: radial-gradient(circle, transparent 30%, rgba(0,0,0,0.5) 100%);
    }

    .wrap {
      position: relative;
      z-index: 10;
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
    }

    /* --- HEADER --- */
    .top {
      margin-bottom: 24px;
      text-align: left;
    }

    .brand-sm {
      font-family: "Archivo", sans-serif;
      font-size: 32px;
      font-weight: 900;
      font-style: italic;
      line-height: 0.9;
      text-transform: uppercase;
      color: var(--paper-shadow);
      margin-bottom: 8px;
    }

    .brand-sm span {
      display: inline-block;
      background: var(--accent);
      color: var(--paper);
      padding: 0px 6px;
      transform: rotate(-3deg);
      box-shadow: 3px 3px 0px rgba(0,0,0,0.2);
    }

    .warning-ticker {
      display: inline-block;
      background: var(--ink);
      color: #FFF;
      font-size: 10px;
      font-weight: 800;
      padding: 6px 10px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      border: 1px solid var(--accent);
    }

    /* --- TABS --- */
    .tab-nav {
      display: flex;
      gap: 10px;
      margin-bottom: 24px;
    }

    .tab-btn {
      flex: 1;
      background: rgba(255,255,255,0.4);
      border: 3px solid var(--ink);
      padding: 12px 4px;
      font-family: "Archivo", sans-serif;
      font-weight: 800;
      font-size: 12px;
      text-transform: uppercase;
      cursor: pointer;
      position: relative;
      color: var(--ink);
      box-shadow: 4px 4px 0px rgba(0,0,0,0.1);
      transition: all 0.1s ease;
      text-align: center;
    }

    .tab-btn.active {
      background: var(--paper);
      transform: translate(-2px, -2px);
      box-shadow: 6px 6px 0px var(--ink);
      z-index: 2;
    }

    .badge {
      display: inline-flex; align-items: center; justify-content: center;
      background: var(--accent); color: white; font-size: 9px;
      height: 18px; min-width: 18px; padding: 0 4px; border-radius: 2px;
      position: absolute; top: -8px; right: -5px; border: 2px solid var(--ink);
      font-family: "JetBrains Mono", monospace; font-weight: 700;
      z-index: 5;
    }

    /* --- CONTENT AREA --- */
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: enter 0.3s ease; }

    @keyframes enter {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h2 {
      font-family: "Archivo", sans-serif; font-size: 16px; font-weight: 800;
      text-transform: uppercase; margin: 32px 0 16px; display: flex; align-items: center; gap: 8px;
      color: var(--ink); letter-spacing: 0.05em;
    }
    h2::before { content: '///'; color: var(--accent); letter-spacing: -2px;}

    .list { display: flex; flex-direction: column; gap: 16px; }

    /* --- CARDS (G-NOTES) --- */
    .item {
      background: var(--paper);
      border: 3px solid var(--ink);
      padding: 20px;
      position: relative;
      box-shadow: 8px 8px 0px rgba(0,0,0,0.15);
      transition: transform 0.1s;
    }
    
    .item:hover { transform: translate(-2px, -2px); box-shadow: 10px 10px 0px rgba(0,0,0,0.2); }

    .meta {
      font-family: "Archivo", sans-serif;
      font-size: 10px; font-weight: 800; text-transform: uppercase;
      color: var(--accent); margin-bottom: 12px; letter-spacing: 0.05em;
      border-bottom: 2px solid rgba(0,0,0,0.1); padding-bottom: 8px;
      display: flex; justify-content: space-between;
    }

    .text {
      font-size: 14px; line-height: 1.5; font-weight: 500; color: var(--ink);
    }

    /* --- INTERACTION --- */
    .townhall-actions {
      display: flex; gap: 8px; margin-top: 16px; padding-top: 12px;
      border-top: 2px dashed rgba(0,0,0,0.2);
    }

    .action-pill {
      flex: 1; background: #fff; border: 2px solid var(--ink);
      padding: 8px; font-size: 11px; font-weight: 800; text-align: center;
      cursor: pointer; transition: 0.1s; font-family: "Archivo", sans-serif;
      text-transform: uppercase;
    }
    .action-pill:active { transform: scale(0.98); background: var(--ink); color: white; }
    
    .action-pill.liked {
      background: var(--accent); color: white; border-color: var(--ink);
      box-shadow: 2px 2px 0px var(--ink);
    }

    .th-timer {
      background: var(--ink); color: #fff; padding: 2px 4px; font-size: 9px;
    }

    /* --- FORMS & INPUTS --- */
    .status, .prompt {
      margin-top: 16px; font-size: 10px; font-weight: 700;
      display: inline-block; padding: 4px 6px; border: 2px solid var(--ink);
      text-transform: uppercase;
    }
    .status { background: #E0E0E0; }
    .prompt { color: var(--paper); background: var(--accent); border-color: var(--accent); }

    .reply-box {
      margin-top: 16px; padding: 12px; background: rgba(0,0,0,0.05);
      border-left: 4px solid var(--accent); font-size: 12px; font-style: italic;
    }

    textarea, input {
      width: 100%; background: #FFF; border: 3px solid var(--ink);
      padding: 14px; color: var(--ink); font-family: "JetBrains Mono", monospace;
      font-size: 14px; resize: none; outline: none; border-radius: 0; margin-top: 12px;
      transition: all 0.2s;
    }
    textarea:focus, input:focus {
      box-shadow: 6px 6px 0px var(--accent);
      transform: translate(-2px, -2px);
    }

    /* --- BUTTONS (3D Style) --- */
    button {
      width: 100%; height: 50px;
      background: #FFFFFF; color: var(--ink);
      border: 3px solid var(--ink);
      font-family: "Archivo", sans-serif; font-weight: 800;
      font-size: 14px; text-transform: uppercase; letter-spacing: 0.1em;
      transform: translate(0, 0); box-shadow: 4px 4px 0px var(--accent);
      transition: all 0.1s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      cursor: pointer; margin-top: 12px;
    }
    button:hover {
      transform: translate(-2px, -2px); box-shadow: 6px 6px 0px var(--accent);
    }
    button:active {
      transform: translate(2px, 2px); box-shadow: 0px 0px 0px var(--accent);
    }

    /* --- CHAT LIST --- */
    .chat-item {
      background: var(--ink); color: var(--paper);
      border: 3px solid var(--ink); padding: 16px;
      margin-bottom: 12px; cursor: pointer;
      box-shadow: 6px 6px 0px rgba(0,0,0,0.2);
    }
    .chat-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .chat-peer { font-weight: 800; font-size: 14px; text-transform: uppercase; }
    
    .countdown-timer {
      font-size: 10px; font-weight: 800; color: var(--bg-gradient-start);
      border: 1px solid var(--bg-gradient-start); padding: 2px 4px;
    }
    .chat-preview { font-size: 10px; opacity: 0.7; font-family: "Archivo", sans-serif; letter-spacing: 0.05em; }

    /* --- COMPOSER --- */
    .composer {
      position: fixed; left: 0; right: 0; bottom: 0;
      background: var(--ink); border-top: 4px solid var(--accent);
      padding: 16px 20px; z-index: 50;
      box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .composer.collapsed {
      padding: 12px 20px; background: var(--paper); border-top: 4px solid var(--ink);
    }

    .composer-header-row {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;
    }

    .context {
      font-family: "Archivo", sans-serif; font-size: 20px; font-weight: 900;
      color: var(--bg-gradient-start); text-transform: uppercase; font-style: italic;
    }
    .composer.collapsed .context { color: var(--ink); font-size: 16px; }

    .collapse-toggle {
      font-size: 10px; font-weight: 800; color: var(--paper);
      text-transform: uppercase; cursor: pointer; padding: 4px 8px;
      border: 1px solid var(--paper);
    }
    .composer.collapsed .collapse-toggle { color: var(--ink); border-color: var(--ink); }

    .nudge-text {
      font-size: 11px; color: #888; margin-bottom: 12px;
    }
    .composer.collapsed .nudge-text { display: none; }

    /* Collapsed Input Style */
    .collapsed-row { display: block; }
    .composer.collapsed .collapsed-row { display: flex; gap: 10px; align-items: center; }
   
    .composer textarea, .composer input {
      border: 2px solid #333; background: #222; color: var(--paper); margin-top: 8px;
      box-shadow: none;
    }
    .composer.collapsed textarea, .composer.collapsed input {
      border: 2px solid var(--ink); background: #FFF; color: var(--ink); margin: 0; height: 44px; padding: 10px;
    }

    .composer button {
      background: var(--bg-gradient-start); color: var(--ink); box-shadow: 4px 4px 0 var(--paper); border-color: var(--paper);
      animation: attention 4s infinite ease-in-out;
    }
    
    /* Subtle breathing animation to urge click */
    @keyframes attention {
      0%, 90%, 100% { transform: scale(1); }
      95% { transform: scale(1.02) rotate(-1deg); }
    }

    .composer.collapsed .hint, .composer.collapsed .action, .composer.collapsed .footer { display: none; }
    .hint { font-size: 10px; color: #666; margin-top: 6px; text-align: right;}
    .footer { margin-top: 16px; font-size: 9px; text-align: center; color: #444; text-transform: uppercase; letter-spacing: 0.1em; }

    /* Townhall Mode Colors */
    .composer.mode-townhall #targetEmail { display: none; }
    .composer.mode-townhall button { background: var(--accent); color: white; border-color: white; box-shadow: 4px 4px 0 var(--ink); }

    /* --- BOTTOM SHEET --- */
    .overlay {
      position: fixed; inset: 0; background: rgba(18, 18, 18, 0.9);
      backdrop-filter: blur(4px); z-index: 99; opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .overlay.active { opacity: 1; pointer-events: auto; }

    .bottom-sheet {
      position: fixed; left: 0; right: 0; bottom: -100%;
      background: var(--paper); border-top: 4px solid var(--ink);
      padding: 32px 24px 48px; z-index: 100;
      transition: bottom 0.4s cubic-bezier(0.19, 1, 0.22, 1);
      box-shadow: 0 -20px 50px rgba(0,0,0,0.7); max-height: 85vh; overflow-y: auto;
    }
    .bottom-sheet.active { bottom: 0; }

    .drag-handle { width: 40px; height: 6px; background: var(--ink); margin: 0 auto 24px; opacity: 0.2;}

    .bs-title {
      font-family: "Archivo", sans-serif; font-size: 24px; font-weight: 900;
      font-style: italic; text-transform: uppercase; margin-bottom: 16px;
      color: var(--ink);
    }
    
    .bs-body { font-size: 14px; margin-bottom: 20px; line-height: 1.4; }

    .comment-list { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
    .comment-item { background: #FFF; padding: 12px; border: 2px solid var(--ink); box-shadow: 4px 4px 0 rgba(0,0,0,0.05); }
    .comment-meta { font-size: 9px; font-weight: 800; color: var(--accent); margin-bottom: 4px; text-transform: uppercase;}

    .bs-btn { background: var(--ink); color: var(--paper); border: none; box-shadow: 6px 6px 0 var(--accent); }
    .bs-btn-secondary { background: transparent; color: var(--ink); border: none; font-size: 12px; margin-top: 16px; text-decoration: underline; box-shadow: none; height: auto;}

    .empty { padding: 30px; text-align: center; border: 2px dashed var(--ink); color: var(--ink); font-size: 12px; opacity: 0.6; font-weight: 700; text-transform: uppercase;}
    
    #hotGoss {
      border: 3px solid var(--accent); background: #FFF5F5;
      padding: 16px; margin: 20px 0; box-shadow: 8px 8px 0 var(--accent);
      transform: rotate(-1deg);
    }
    #hotGoss h2 { margin-top: 0; color: var(--accent); font-size: 14px;}
    #hotGossCount { background: var(--accent); color: white; padding: 2px 6px; font-size: 10px; margin-left: 8px; vertical-align: middle;}

    @media (max-width: 600px) {
        .brand-sm { font-size: 28px; }
        .composer button { font-size: 12px; }
    }

  </style>
</head>

<body>
  <div class="grain"></div>
  <div class="vignette"></div>

  <div class="wrap">
    <div class="top">
      <div class="brand-sm">
        Oh my <br>
        <span>GOSS</span>
      </div>
      <div class="warning-ticker">
        ‚ö†Ô∏è Official Townhall
      </div>
    </div>

    <div class="tab-nav">
      <button class="tab-btn" onclick="switchTab('tapri')" id="btn-tapri">
        Water Cooler (PUBLIC)
      </button>
      <button class="tab-btn active" onclick="switchTab('desk')" id="btn-desk">
        My Desk (PRIVATE)
        <span id="deskBadge" class="badge" style="display:none">0</span>
      </button>
    </div>

    <div id="view-tapri" class="tab-content">
      <div id="townhallFeed" class="list"></div>
    </div>

    <div id="view-desk" class="tab-content active">
      <div id="hotGoss" style="display:none;">
        <h2>
          ‚ö†Ô∏è URGENT
          <span id="hotGossCount"></span>
        </h2>
        <div id="inboxList" class="list"></div>
        <div id="sentInline" class="list"></div>
      </div>

      <h2>Encrypted Chats</h2>
      <div class="chat-list" id="chatList"></div>
    </div>

    <div class="composer collapsed" id="mainComposer">
      <div class="composer-header-row">
        <div class="context" id="composerHeader">GOT A SECRET?</div>
        <div class="collapse-toggle" onclick="toggleComposer()" id="composerToggle">‚ñ≤ WRITE</div>
      </div>
      
      <div class="nudge-text" id="composerNudge">Don't let the truth get in the way of a good story.</div>

      <div class="collapsed-row">
        <input id="targetEmail" type="email" placeholder="TARGET WORK EMAIL">
        <textarea id="rantText" placeholder="Start typing..."></textarea>
      </div>

      <div class="hint">delivery is quiet ¬∑ no name attached</div>

      <div class="action">
        <button id="sendBtn" onclick="handleSend()">DROP MSG</button>
      </div>

      <div class="footer">CAN'T WAIT TO HEAR IT</div>
    </div>
  </div>

  <div class="overlay" id="sheetOverlay" onclick="closeBottomSheet()"></div>
  <div class="bottom-sheet" id="dynamicSheet">
    <div class="drag-handle"></div>
    <div id="sheetContent"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // --- CONFIGURATION ---
    const PRIVATE_TTL_MINS = 15; 
    const PUBLIC_TTL_HOURS = 1; 
 
    // --- Global State ---
    window.__hotInboxPending = 0;
    window.__hotSentPending = 0;
    window.__inboxReady = false;
    window.__sentReady = false;
    let currentTab = "desk";
    let activeChats = []; 
    let activeTownhallPosts = [];
    const userExistenceCache = {};
 
    // --- TIMER ---
    setInterval(() => {
      const now = new Date();
      activeChats.forEach(chat => {
        const el = document.getElementById(`timer-${chat.id}`);
        if (!el) return;
        const expiresAt = new Date(chat.createdAt.toDate().getTime() + PRIVATE_TTL_MINS * 60000);
        const diff = expiresAt - now;
        if (diff <= 0) {
          deleteChat(chat.id);
        } else {
          const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          const secs = Math.floor((diff % (1000 * 60)) / 1000);
          el.innerText = `üí• ${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
      });
 
      activeTownhallPosts.forEach(post => {
         const el = document.getElementById(`th-timer-${post.id}`);
         if (!el) return;
         const expiresAt = new Date(post.createdAt.toDate().getTime() + (PUBLIC_TTL_HOURS * 60 * 60 * 1000));
         const diff = expiresAt - now;
         if (diff <= 0) {
             deleteTownhallPost(post.id);
         } else {
             const hrs = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
             const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
             el.innerText = `‚è≥ ${hrs}h ${mins}m LEFT`;
         }
      });
    }, 1000);
 
    function deleteChat(chatId) { db.collection("chats").doc(chatId).delete().catch(console.error); }
    function deleteTownhallPost(postId) { db.collection("townhall").doc(postId).delete().catch(console.error); }
 
    // --- TAB & UI LOGIC ---
    function switchTab(tabName) {
      currentTab = tabName;
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.getElementById(`view-${tabName}`).classList.add('active');
      
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      document.getElementById(`btn-${tabName}`).classList.add('active');
 
      const composer = document.getElementById('mainComposer');
      const btn = document.getElementById('sendBtn');
      
      if (tabName === 'tapri') {
        composer.classList.add('mode-townhall');
        btn.innerText = "POST TO TOWN HALL";
      } else {
        composer.classList.remove('mode-townhall');
        btn.innerText = "DROP MSG";
      }
      updateComposerText();
    }
 
    function updateComposerText() {
      const isCollapsed = document.getElementById('mainComposer').classList.contains('collapsed');
      const header = document.getElementById('composerHeader');
      const toggle = document.getElementById('composerToggle');
      const nudge = document.getElementById('composerNudge');
 
      if (isCollapsed) {
         header.innerText = "GOT A SECRET?";
         toggle.innerText = "‚ñ≤ WRITE";
      } else {
         header.innerText = "SPILL THE TEA";
         toggle.innerText = "‚ñº MINIMIZE";
         nudge.innerText = "Make them panic. Or make them laugh. Just make it stick.";
      }
    }
 
    function toggleComposer() {
      document.querySelector(".composer").classList.toggle("collapsed");
      updateComposerText();
    }
 
    ["targetEmail", "rantText"].forEach(id => {
      document.getElementById(id).addEventListener("focus", () => {
        document.querySelector(".composer").classList.remove("collapsed");
        updateComposerText();
      });
    });
 
    // --- FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyDqwklNFPF09IiE1Gh6_ckJr2Jz6F0V2f8", 
      authDomain: "rant-2me.firebaseapp.com",
      projectId: "rant-2me"
    };
 
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
 
    auth.onAuthStateChanged(user => {
      if (!user) { window.location.href = "index.html"; return; }
      db.collection("users").doc(user.uid).set({ email: user.email, lastSeen: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
      loadInboxInline(user.email);
      loadSentInline(user.email);
      loadChats(user.email);
      loadTownhall(user.email);
    });
 
    // --- TOWNHALL LOGIC ---
    function loadTownhall(myEmail) {
      db.collection("townhall").orderBy("createdAt", "desc").limit(50).onSnapshot(snapshot => {
          const list = document.getElementById("townhallFeed");
          list.innerHTML = "";
          activeTownhallPosts = [];
 
          if (snapshot.empty) {
             list.innerHTML = "<div class='empty'>THE TOWN SQUARE IS SILENT</div>";
             return;
          }
 
          snapshot.forEach(doc => {
             const data = doc.data();
             activeTownhallPosts.push({ id: doc.id, createdAt: data.createdAt });
             
             const likedBy = data.likedBy || [];
             const isLiked = likedBy.includes(myEmail);
             const likesCount = likedBy.length;
             const comments = data.commentCount || 0;
 
             list.innerHTML += `
               <div class="item">
                 <div class="meta">
                    <span>ANONYMOUS</span>
                    <span class="th-timer" id="th-timer-${doc.id}">...</span>
                 </div>
                 <div class="text" style="font-size:16px">${data.text}</div>
                 
                 <div class="townhall-actions">
                     <div class="action-pill ${isLiked ? 'liked' : ''}" onclick="likePost('${doc.id}')">
                         ${isLiked ? '‚ù§Ô∏è' : '‚ô°'} ${likesCount}
                     </div>
                     <div class="action-pill" onclick="openThread('${doc.id}', '${escape(data.text)}')">
                         üí¨ ${comments}
                     </div>
                     <div class="action-pill" onclick="sharePost('${escape(data.text)}')">
                         üì¢ SHARE
                     </div>
                 </div>
               </div>
             `;
          });
        });
    }
 
    function likePost(postId) {
        const user = auth.currentUser;
        if(!user) return;
        const ref = db.collection("townhall").doc(postId);
        
        // Use Firestore ArrayUnion to ensure unique likes
        ref.update({
            likedBy: firebase.firestore.FieldValue.arrayUnion(user.email)
        });
    }
 
    function sharePost(escapedText) {
        const text = unescape(escapedText);
        const subject = "üëÄ You know what is being circulated today?";
        const body = `Saw this on the townhall just now:\n\n"${text}"\n\nIt vanishes in a few hours. Check it out: https://oh-my-goss.netlify.app/`;
        window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    }
 
    function openThread(postId, escapedText) {
        const text = unescape(escapedText);
        const container = document.getElementById('sheetContent');
        
        container.innerHTML = `
           <div class="bs-title">Gossip Thread</div>
           <div style="background:#FFFDF0; padding:16px; border:2px solid black; margin-bottom:20px;">"${text}"</div>
           <div class="bs-title" style="font-size:16px; border:none;">Comments</div>
           <div id="bs-comments" class="comment-list"><div class="empty">Loading whispers...</div></div>
           <textarea id="threadComment" placeholder="Add your whisper..." style="margin-bottom:8px;"></textarea>
           <button class="bs-btn" onclick="postComment('${postId}')">REPLY TO THREAD</button>
        `;
        
        document.getElementById('sheetOverlay').classList.add('active');
        document.getElementById('dynamicSheet').classList.add('active');
 
        db.collection("townhall").doc(postId).collection("comments").orderBy("createdAt", "asc").onSnapshot(snap => {
              const list = document.getElementById("bs-comments");
              list.innerHTML = "";
              if(snap.empty) { list.innerHTML = "<div class='empty'>No comments yet. Start the drama.</div>"; return; }
              snap.forEach(d => {
                  list.innerHTML += `<div class="comment-item"><div class="comment-meta">ANONYMOUS ¬∑ JUST NOW</div><div>${d.data().text}</div></div>`;
              });
        });
    }
 
    function postComment(postId) {
        const input = document.getElementById('threadComment');
        const text = input.value.trim();
        if(!text) return;
 
        const batch = db.batch();
        const postRef = db.collection("townhall").doc(postId);
        const commentRef = postRef.collection("comments").doc();
 
        batch.set(commentRef, { text: text, createdAt: new Date() });
        batch.update(postRef, { commentCount: firebase.firestore.FieldValue.increment(1) });
        batch.commit().then(() => { input.value = ""; });
    }
 
    // --- SENDING LOGIC ---
    function handleSend() {
        if (currentTab === 'tapri') sendTownhallPost();
        else sendPrivateRant();
    }
 
    function sendTownhallPost() {
        const textEl = document.getElementById("rantText");
        const text = textEl.value.trim();
        if(!text) return;
        if (text.length > 2000) return;
 
        db.collection("townhall").add({
            text: text, createdAt: new Date(), likedBy: [], commentCount: 0
        }).then(() => {
            textEl.value = ""; toggleComposer();
            if(currentTab !== 'tapri') switchTab('tapri');
        });
    }
 
    function sendPrivateRant() {
      const textEl = document.getElementById("rantText");
      const targetEl = document.getElementById("targetEmail");
      const text = textEl.value.trim();
      const target = targetEl.value.trim();
      const user = auth.currentUser;
 
      if (!text || !target || !user) return;
      if (text.length > 2000) return;
 
      db.collection("rants").add({
        from: user.email, to: target, text, status: "pending", createdAt: new Date()
      }).then(() => {
        textEl.value = ""; targetEl.value = ""; toggleComposer();
        checkUserExists(target).then(exists => {
          if (!exists) {
             document.getElementById('sheetContent').innerHTML = `
                <div class="bs-title">They aren't here yet</div>
                <div class="bs-body">This person hasn't signed up. Your whisper is pending, but they won't see it until they join.</div>
                <button class="bs-btn" onclick="sendInviteEmail('${target}')">SEND MYSTERIOUS INVITE</button>
                <button class="bs-btn-secondary" onclick="closeBottomSheet()">I'll wait for them</button>
             `;
             document.getElementById('sheetOverlay').classList.add('active');
             document.getElementById('dynamicSheet').classList.add('active');
          }
        });
      });
    }
    
    async function checkUserExists(email) {
      if (userExistenceCache[email] !== undefined) return userExistenceCache[email];
      try {
        const snap = await db.collection("users").where("email", "==", email).limit(1).get();
        userExistenceCache[email] = !snap.empty;
        return !snap.empty;
      } catch (e) { return false; }
    }
 
    function closeBottomSheet() {
      document.getElementById('sheetOverlay').classList.remove('active');
      document.getElementById('dynamicSheet').classList.remove('active');
    }
 
    function sendInviteEmail(target) {
      window.location.href = `mailto:${target}?subject=Someone is talking about you ü§´&body=Someone dropped a hot goss about you. Check it out: https://oh-my-goss.netlify.app/`;
      closeBottomSheet();
    }
 
    function updateHotGossVisibility() {
      if (!window.__inboxReady || !window.__sentReady) return;
      const hot = document.getElementById("hotGoss");
      const countEl = document.getElementById("hotGossCount");
      const badgeEl = document.getElementById("deskBadge");
      const total = (window.__hotInboxPending || 0) + (window.__hotSentPending || 0);
 
      if (total > 0) {
        hot.style.display = "block";
        countEl.textContent = total + " PENDING";
        badgeEl.style.display = "inline-flex";
        badgeEl.textContent = total;
      } else {
        hot.style.display = "none";
        badgeEl.style.display = "none";
      }
    }
 
    // --- DESK DATA LOADER (No Empty States shown) ---
    function loadSentInline(email) {
      db.collection("rants").where("from", "==", email).onSnapshot(snapshot => {
          window.__hotSentPending = 0; window.__sentReady = true;
          const container = document.getElementById("sentInline");
          container.innerHTML = "";
          const docs = snapshot.docs.sort((a, b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0));
          
          docs.forEach(doc => {
            const rant = doc.data();
            if (rant.status === "accepted") return;
            if (rant.status === "pending" || rant.status === "echoed") window.__hotSentPending++;
            
            const echoBlock = rant.echo ? `<div class="reply-box">${rant.echo}</div>` : "";
            const statusText = rant.status === "pending" ? "<span style='color:var(--accent)'>WAITING FOR REPLY</span>" : rant.status === "echoed" ? "REPLY RECEIVED" : rant.status;
            
            let actionBlock = "";
            if (rant.status === "echoed") {
                actionBlock = `<div class="action"><button onclick="acceptEchoInline('${doc.id}')">UNLOCK & START CHAT</button></div>`;
            }
            
            container.innerHTML += `
              <div class="item">
                <div class="meta">OUTGOING ¬∑ TO ${rant.to}</div>
                <div class="text">${rant.text}</div>
                <div class="status">STATUS: ${statusText}</div>
                ${echoBlock} ${actionBlock}
              </div>`;
          });
          updateHotGossVisibility();
        });
    }
 
    function loadInboxInline(email) {
      db.collection("rants").where("to", "==", email).onSnapshot(snapshot => {
          window.__hotInboxPending = 0; window.__inboxReady = true;
          const container = document.getElementById("inboxList");
          container.innerHTML = "";
          
          const docs = snapshot.docs.sort((a, b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0));
          docs.forEach(doc => {
            const rant = doc.data();
            if (rant.status === "accepted") return;
            if (rant.status === "pending" || rant.status === "echoed") window.__hotInboxPending++;
 
            let block = "";
            if (rant.status === "pending") {
              block = `<div class="prompt">ACTION REQUIRED</div>
                <textarea id="echo-${doc.id}" placeholder="Reply to unlock this chat..."></textarea>
                <div class="action"><button onclick="submitEcho('${doc.id}')">REPLY TO UNLOCK</button></div>`;
            } else if (rant.status === "echoed") {
              block = `<div class="reply-box">${rant.echo}</div><div class="status">WAITING ON SENDER TO UNLOCK</div>`;
            }
 
            container.innerHTML += `<div class="item"><div class="meta">INCOMING ¬∑ ANONYMOUS</div><div class="text">${rant.text}</div>${block}</div>`;
          });
          updateHotGossVisibility();
        });
    }
 
    function submitEcho(rantId) {
      const input = document.getElementById(`echo-${rantId}`);
      if (!input || !input.value.trim()) return;
      db.collection("rants").doc(rantId).update({ echo: input.value.trim(), status: "echoed", updatedAt: new Date() });
    }
 
    function acceptEchoInline(rantId) {
      const chatRef = db.collection("chats").doc();
      db.collection("rants").doc(rantId).get().then(doc => {
        const rant = doc.data();
        chatRef.set({
          users: [rant.from, rant.to], createdAt: new Date(),
          seed: [{ from: rant.from, text: rant.text, createdAt: rant.createdAt || new Date() }, { from: rant.to, text: rant.echo, createdAt: new Date() }]
        });
        db.collection("rants").doc(rantId).update({ status: "accepted", chatId: chatRef.id, updatedAt: new Date() })
          .then(() => window.location.href = `chat.html?chatId=${chatRef.id}`);
      });
    }
    
    function loadChats(userEmail) {
      db.collection("chats").where("users", "array-contains", userEmail).onSnapshot(snapshot => {
          const list = document.getElementById("chatList");
          list.innerHTML = ""; activeChats = [];
          if (snapshot.empty) { list.innerHTML = "<div class='empty'>NO LATEST GOSS?</div>"; return; }
          snapshot.forEach(doc => {
            const chat = doc.data();
            activeChats.push({ id: doc.id, createdAt: chat.createdAt });
            const peer = chat.users.find(u => u !== userEmail);
            list.innerHTML += `<div class="chat-item" onclick="openChat('${doc.id}')">
                <div class="chat-row"><div class="chat-peer">${peer}</div><div class="countdown-timer" id="timer-${doc.id}">...</div></div>
                <div class="chat-preview">/// ENCRYPTED - TAP TO VIEW</div></div>`;
          });
        });
    }
    function openChat(chatId) { window.location.href = `chat.html?chatId=${chatId}`; }
  </script>
</body>
</html>