<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8" />
 <title>Goss ¬∑ Townhall</title>
 <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

 <link href="https://fonts.googleapis.com/css2?family=Archivo:ital,wdth,wght@0,100..900;1,100..900&family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">

 <style>
   :root {
     /* Palette */
     --bg-color: #FFD600; /* Electric Yellow */
     --accent: #FF4800;   /* Hot Orange */
     --ink: #101010;      /* Pure Black */
     --paper: #FFFFFF;
     --grey: #F0F0F0;
   }

   * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

   body {
     margin: 0;
     background-color: var(--bg-color);
     background-image: radial-gradient(circle at top center, #FFD600 0%, #FFC107 100%);
     color: var(--ink);
     font-family: "JetBrains Mono", monospace;
     overflow-x: hidden;
     min-height: 100vh;
     padding-bottom: 140px; 
   }

   .grain {
     position: fixed;
     inset: 0;
     pointer-events: none;
     background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.05'/%3E%3C/svg%3E");
     z-index: 0;
     mix-blend-mode: multiply;
   }

   .wrap {
     max-width: 500px;
     margin: 0 auto;
     padding: 20px;
     position: relative;
     z-index: 1;
   }

   /* --- HEADER --- */
   .top {
     margin-bottom: 24px;
     border-bottom: 4px solid var(--ink);
     padding-bottom: 16px;
   }

   .top h1 {
     font-family: "Archivo", sans-serif;
     font-size: 52px;
     font-weight: 900;
     font-style: italic;
     letter-spacing: -0.04em;
     margin: 0;
     text-transform: uppercase;
     line-height: 0.9;
   }

   .top p {
     margin-top: 8px;
     font-size: 13px;
     font-weight: 700;
     background: var(--ink);
     color: var(--bg-color);
     display: inline-block;
     padding: 4px 8px;
     transform: rotate(-1deg);
   }
   
   .top .warning-ticker {
     display: block;
     background: var(--accent);
     color: white;
     font-size: 11px;
     font-weight: 800;
     padding: 6px;
     margin-top: 12px;
     text-transform: uppercase;
     text-align: center;
     border: 2px solid var(--ink);
   }

   /* --- TABS --- */
   .tab-nav {
     display: flex;
     border: 3px solid var(--ink);
     background: var(--paper);
     margin-bottom: 32px;
     box-shadow: 6px 6px 0px rgba(0,0,0,0.15);
   }

   .tab-btn {
     flex: 1;
     background: transparent;
     border: none;
     border-right: 3px solid var(--ink);
     padding: 16px 8px;
     font-family: "Archivo", sans-serif;
     font-weight: 800;
     font-size: 14px;
     text-transform: uppercase;
     cursor: pointer;
     position: relative;
     color: var(--ink);
     transition: all 0.2s;
     box-shadow: none;
     margin: 0;
   }

   .tab-btn:last-child { border-right: none; }

   .tab-btn.active {
     background: var(--ink);
     color: var(--bg-color);
   }

   /* Notification Counter */
   .badge {
     display: inline-flex;
     align-items: center;
     justify-content: center;
     background: var(--accent);
     color: white;
     font-size: 10px;
     height: 18px;
     min-width: 18px;
     padding: 0 5px;
     border-radius: 99px;
     position: absolute;
     top: 10px;
     right: 10px;
     border: 2px solid var(--ink);
     font-family: "JetBrains Mono", monospace;
   }
   
   .tab-btn.active .badge { border-color: var(--bg-color); }

   /* --- SECTIONS & CARDS --- */
   .tab-content { display: none; }
   .tab-content.active { display: block; animation: fadeIn 0.3s ease; }

   @keyframes fadeIn {
     from { opacity: 0; transform: translateY(10px); }
     to { opacity: 1; transform: translateY(0); }
   }

   h2 {
     font-family: "Archivo", sans-serif;
     font-size: 18px;
     font-weight: 800;
     text-transform: uppercase;
     margin: 32px 0 16px;
     display: flex;
     align-items: center;
     gap: 12px;
   }
  
   h2::before {
     content: '';
     display: block;
     width: 12px;
     height: 12px;
     background: var(--ink);
   }

   .list { display: flex; flex-direction: column; gap: 16px; }

   .item {
     background: var(--paper);
     border: 3px solid var(--ink);
     box-shadow: 6px 6px 0px rgba(0,0,0,0.15);
     padding: 20px;
     position: relative;
     transition: transform 0.1s;
   }
  
   .item:active { transform: translate(2px, 2px); box-shadow: 4px 4px 0 rgba(0,0,0,0.15); }

   .meta {
     font-size: 10px;
     font-weight: 700;
     text-transform: uppercase;
     color: var(--accent);
     margin-bottom: 12px;
     letter-spacing: 0.05em;
     border-bottom: 2px solid var(--grey);
     padding-bottom: 8px;
     display: flex;
     justify-content: space-between;
   }

   .text {
     font-size: 15px;
     line-height: 1.5;
     font-weight: 600;
     color: var(--ink);
   }

   /* --- TOWNHALL SPECIFIC --- */
   .townhall-actions {
     display: flex;
     gap: 8px;
     margin-top: 16px;
     padding-top: 12px;
     border-top: 2px dashed var(--grey);
   }

   .action-pill {
     flex: 1;
     background: var(--bg-color);
     border: 2px solid var(--ink);
     padding: 8px;
     font-size: 12px;
     font-weight: 800;
     text-align: center;
     cursor: pointer;
     transition: 0.1s;
     display: flex;
     align-items: center;
     justify-content: center;
     gap: 6px;
   }

   .action-pill:hover { background: white; }
   .action-pill:active { transform: scale(0.98); }
   .action-pill.liked { background: var(--accent); color: white; border-color: var(--ink); }

   .th-timer {
     background: var(--ink);
     color: var(--bg-color);
     padding: 2px 6px;
     font-size: 10px;
   }

   /* --- FORMS --- */
   .status, .prompt {
     margin-top: 16px;
     font-size: 11px;
     font-weight: 700;
     display: inline-block;
     padding: 4px 8px;
     border: 2px solid var(--ink);
   }
   .status { background: var(--grey); }
   .prompt { color: var(--accent); background: rgba(255, 85, 0, 0.1); }

   .reply-box {
     margin-top: 16px;
     padding: 12px;
     background: var(--bg-color);
     border: 2px solid var(--ink);
     font-size: 13px;
     font-style: italic;
     position: relative;
   }

   textarea, input {
     width: 100%;
     background: var(--paper);
     border: 3px solid var(--ink);
     padding: 14px;
     color: var(--ink);
     font-family: "JetBrains Mono", monospace;
     font-size: 14px;
     resize: none;
     outline: none;
     border-radius: 0;
     margin-top: 12px;
   }
  
   button {
     width: 100%;
     padding: 16px;
     background: var(--ink);
     border: 3px solid var(--ink);
     color: var(--bg-color);
     font-family: "Archivo", sans-serif;
     font-weight: 800;
     font-size: 14px;
     text-transform: uppercase;
     cursor: pointer;
     margin-top: 12px;
     box-shadow: 4px 4px 0px var(--accent);
   }
   button:active { transform: translate(2px, 2px); box-shadow: 0px 0px 0px var(--accent); }

   .invite-btn {
     background: var(--accent);
     color: white;
     border-color: var(--ink);
     box-shadow: 4px 4px 0 var(--ink);
   }

   /* --- CHAT LIST --- */
   .chat-item {
     background: var(--paper);
     border: 3px solid var(--ink);
     padding: 16px;
     margin-bottom: 12px;
     cursor: pointer;
     transition: transform 0.1s;
     display: flex;
     flex-direction: column;
     gap: 8px;
   }
   
   .chat-row { display: flex; justify-content: space-between; align-items: center; }
   .chat-peer { font-weight: 800; font-size: 14px; }
   .countdown-timer {
     font-size: 11px;
     font-weight: 800;
     color: var(--accent);
     background: rgba(255, 72, 0, 0.1);
     padding: 2px 6px;
     border: 1px solid var(--accent);
   }
   .chat-preview { font-size: 11px; opacity: 0.6; }

   /* --- COMPOSER --- */
   .composer {
     position: fixed; left: 0; right: 0; bottom: 0;
     background: var(--ink);
     border-top: 4px solid var(--accent);
     padding: 16px 20px;
     z-index: 50;
     transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
   }

   .composer.collapsed { padding: 12px 20px; background: var(--paper); border-top: 4px solid var(--ink); }

   .collapse-toggle {
     font-size: 10px; font-weight: 800; color: var(--paper);
     text-transform: uppercase; text-align: right; cursor: pointer; margin-bottom: 8px;
   }
   .composer.collapsed .collapse-toggle { color: var(--ink); }

   .context {
     font-family: "Archivo", sans-serif; font-size: 14px; font-weight: 700;
     color: var(--bg-color); margin-bottom: 12px; text-transform: uppercase;
   }
   .composer.collapsed .context { display: none; }

   .collapsed-row { display: block; }
   .composer.collapsed .collapsed-row { display: flex; gap: 10px; align-items: center; }
  
   .composer textarea, .composer input {
     border: 2px solid var(--bg-color); background: #222; color: var(--bg-color); margin-top: 8px;
   }
   .composer.collapsed textarea, .composer.collapsed input {
     border: 2px solid var(--ink); background: var(--paper); color: var(--ink); margin: 0; height: 44px; padding: 10px;
   }

   .composer button {
     background: var(--bg-color); color: var(--ink); box-shadow: 4px 4px 0 var(--paper); border-color: var(--paper);
   }

   .composer.collapsed .hint, .composer.collapsed .action, .composer.collapsed .footer { display: none; }
   .hint { font-size: 11px; color: var(--paper); opacity: 0.7; margin-top: 4px; }
   .footer { margin-top: 16px; font-size: 10px; text-align: center; color: var(--paper); opacity: 0.5; }

   /* Context Awareness for Composer */
   .composer.mode-townhall #targetEmail { display: none; }
   .composer.mode-townhall .context::after { content: " (PUBLIC BROADCAST)"; opacity: 0.7; }
   .composer.mode-townhall button { background: var(--accent); color: white; border-color: white; }

   /* --- BOTTOM SHEET --- */
   .overlay {
     position: fixed; inset: 0; background: rgba(16, 16, 16, 0.85);
     backdrop-filter: blur(4px); z-index: 99; opacity: 0; pointer-events: none; transition: opacity 0.3s;
   }
   .overlay.active { opacity: 1; pointer-events: auto; }

   .bottom-sheet {
     position: fixed; left: 0; right: 0; bottom: -100%;
     background: var(--bg-color);
     border-top: 4px solid var(--ink);
     padding: 32px 24px 48px;
     z-index: 100;
     transition: bottom 0.4s cubic-bezier(0.19, 1, 0.22, 1);
     box-shadow: 0 -20px 50px rgba(0,0,0,0.5);
     max-height: 85vh;
     overflow-y: auto;
   }
   .bottom-sheet.active { bottom: 0; }

   .drag-handle { width: 60px; height: 6px; background: var(--ink); margin: 0 auto 24px; }

   .bs-title {
     font-family: "Archivo", sans-serif; font-size: 24px; font-weight: 900;
     font-style: italic; text-transform: uppercase; margin-bottom: 16px;
     border-bottom: 3px solid var(--ink); padding-bottom: 12px;
   }

   .bs-body { font-size: 14px; margin-bottom: 24px; font-weight: 600; line-height: 1.5; }

   .comment-list { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
   .comment-item { background: rgba(255,255,255,0.5); padding: 12px; border-left: 3px solid var(--ink); }
   .comment-meta { font-size: 10px; font-weight: 800; opacity: 0.6; margin-bottom: 4px; }

   .bs-btn { background: var(--ink); color: var(--bg-color); border: none; box-shadow: 6px 6px 0 white; }

   .empty { padding: 24px; text-align: center; border: 2px dashed var(--ink); color: var(--ink); font-size: 12px; opacity: 0.6; }
   
   #hotGoss {
     border: 3px solid var(--accent); background: rgba(255, 255, 255, 0.5);
     padding: 16px; margin: 20px 0; box-shadow: 8px 8px 0 var(--accent);
   }
   #hotGoss h2 { margin-top: 0; color: var(--accent); }
   #hotGossCount { background: var(--accent); color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; }

 </style>
</head>

<body>
 <div class="grain"></div>

 <div class="wrap">
   <div class="top">
     <h1>Goss ¬∑ Central</h1>
     <p>UNOFFICIAL TRUTHS ONLY</p>
     <div class="warning-ticker">
       ‚ö†Ô∏è ALL DATA SELF-DESTRUCTS
     </div>
   </div>

   <div class="tab-nav">
     <button class="tab-btn" onclick="switchTab('tapri')" id="btn-tapri">
       WATER COOLER (PUBLIC)
     </button>
     <button class="tab-btn active" onclick="switchTab('desk')" id="btn-desk">
       MY DESK (PRIVATE)
       <span id="deskBadge" class="badge" style="display:none">0</span>
     </button>
   </div>

   <div id="view-tapri" class="tab-content">
     <div id="townhallFeed" class="list">
        </div>
   </div>

   <div id="view-desk" class="tab-content active">
     <div id="hotGoss" style="display:none;">
       <h2>
         URGENT FILES
         <span id="hotGossCount"></span>
       </h2>
       <div id="inboxList" class="list"></div>
       <div id="sentInline" class="list"></div>
     </div>

     <h2>Previous Signals</h2>
     <div class="chat-list" id="chatList"></div>
   </div>

   <div class="composer collapsed" id="mainComposer">
     <div class="collapse-toggle" onclick="toggleComposer()">‚ñº MINIMIZE</div>
     <div class="context" id="composerLabel">Drop an anonymous note</div>

     <div class="collapsed-row">
       <input id="targetEmail" type="email" placeholder="TARGET EMAIL">
       <textarea id="rantText" placeholder="WHAT'S THE SCOOP?"></textarea>
     </div>

     <div class="hint">delivery is quiet ¬∑ no name attached</div>

     <div class="action">
       <button id="sendBtn" onclick="handleSend()">DROP MSG</button>
     </div>

     <div class="footer">ONCE IT‚ÄôS OUT, IT STAYS OUT</div>
   </div>
 </div>

 <div class="overlay" id="sheetOverlay" onclick="closeBottomSheet()"></div>
 
 <div class="bottom-sheet" id="dynamicSheet">
   <div class="drag-handle"></div>
   <div id="sheetContent">
     </div>
 </div>

 <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
 <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
 <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

 <script>
   // --- CONFIGURATION ---
   const PRIVATE_TTL_MINS = 15; 
   const PUBLIC_TTL_HOURS = 12; 

   // --- Global State ---
   window.__hotInboxPending = 0;
   window.__hotSentPending = 0;
   window.__inboxReady = false;
   window.__sentReady = false;
   let currentTab = "desk";
   let activeChats = []; 
   let activeTownhallPosts = [];
  
   const userExistenceCache = {};

   // --- TIMER LOGIC (Runs every second) ---
   setInterval(() => {
     const now = new Date();

     // 1. Private Chat Timers
     activeChats.forEach(chat => {
       const el = document.getElementById(`timer-${chat.id}`);
       if (!el) return;
       const expiresAt = new Date(chat.createdAt.toDate().getTime() + PRIVATE_TTL_MINS * 60000);
       const diff = expiresAt - now;

       if (diff <= 0) {
         deleteChat(chat.id);
       } else {
         const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
         const secs = Math.floor((diff % (1000 * 60)) / 1000);
         el.innerText = `üí• ${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
       }
     });

     // 2. Townhall Feed Timers
     activeTownhallPosts.forEach(post => {
        const el = document.getElementById(`th-timer-${post.id}`);
        if (!el) return;
        const expiresAt = new Date(post.createdAt.toDate().getTime() + (PUBLIC_TTL_HOURS * 60 * 60 * 1000));
        const diff = expiresAt - now;

        if (diff <= 0) {
            deleteTownhallPost(post.id);
            if(el) el.closest('.item').remove(); // Optimistic remove
        } else {
            const hrs = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            el.innerText = `‚è≥ ${hrs}h ${mins}m LEFT`;
        }
     });

   }, 1000);

   function deleteChat(chatId) {
     db.collection("chats").doc(chatId).delete().catch(console.error);
   }

   function deleteTownhallPost(postId) {
       db.collection("townhall").doc(postId).delete().catch(console.error);
   }

   // --- TAB LOGIC ---
   function switchTab(tabName) {
     currentTab = tabName;
     document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
     document.getElementById(`view-${tabName}`).classList.add('active');
     
     document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
     document.getElementById(`btn-${tabName}`).classList.add('active');

     const composer = document.getElementById('mainComposer');
     const label = document.getElementById('composerLabel');
     const btn = document.getElementById('sendBtn');
     
     if (tabName === 'tapri') {
       composer.classList.add('mode-townhall');
       label.innerText = "BROADCAST TO EVERYONE";
       btn.innerText = "POST TO TOWN HALL";
     } else {
       composer.classList.remove('mode-townhall');
       label.innerText = "Drop an anonymous note";
       btn.innerText = "DROP MSG";
     }
   }

   // --- FIREBASE INIT ---
   const firebaseConfig = {
     apiKey: "AIzaSyDqwklNFPF09IiE1Gh6_ckJr2Jz6F0V2f8", // Replace if needed
     authDomain: "rant-2me.firebaseapp.com",
     projectId: "rant-2me"
   };

   firebase.initializeApp(firebaseConfig);
   const auth = firebase.auth();
   const db = firebase.firestore();

   auth.onAuthStateChanged(user => {
     if (!user) {
       window.location.href = "index.html";
       return;
     }
     db.collection("users").doc(user.email).set({ email: user.email, lastSeen: new Date() }, { merge: true });

     loadInboxInline(user.email);
     loadSentInline(user.email);
     loadChats(user.email);
     loadTownhall(); // New Feed
   });

   // --- TOWNHALL LOGIC ---

   function loadTownhall() {
     // Order by time. In real app, you'd filter by createdAt > (Now - 12h) to save reads.
     db.collection("townhall")
       .orderBy("createdAt", "desc")
       .limit(50)
       .onSnapshot(snapshot => {
         const list = document.getElementById("townhallFeed");
         list.innerHTML = "";
         activeTownhallPosts = [];

         if (snapshot.empty) {
            list.innerHTML = "<div class='empty'>THE TOWN SQUARE IS SILENT</div>";
            return;
         }

         snapshot.forEach(doc => {
            const data = doc.data();
            activeTownhallPosts.push({ id: doc.id, createdAt: data.createdAt });
            
            // Likes logic
            const likes = data.likes || 0;
            const comments = data.commentCount || 0;

            list.innerHTML += `
              <div class="item">
                <div class="meta">
                   <span>ANONYMOUS</span>
                   <span class="th-timer" id="th-timer-${doc.id}">CALCULATING...</span>
                </div>
                <div class="text" style="font-size:18px">${data.text}</div>
                
                <div class="townhall-actions">
                    <div class="action-pill" onclick="likePost('${doc.id}')">
                        ‚ù§Ô∏è ${likes}
                    </div>
                    <div class="action-pill" onclick="openThread('${doc.id}', '${escape(data.text)}')">
                        üí¨ ${comments}
                    </div>
                    <div class="action-pill" onclick="sharePost('${escape(data.text)}')">
                        üì¢ SHARE
                    </div>
                </div>
              </div>
            `;
         });
       });
   }

   function likePost(postId) {
       // Simple increment. For strict unique likes, we'd need a subcollection or array of UIDs.
       // Keeping it "loose" for anonymity speed.
       const ref = db.collection("townhall").doc(postId);
       ref.update({
           likes: firebase.firestore.FieldValue.increment(1)
       });
   }

   function sharePost(escapedText) {
       const text = unescape(escapedText);
       const subject = "üëÄ You know what is being circulated today?";
       const body = `Saw this on the townhall just now:\n\n"${text}"\n\nIt vanishes in a few hours. Check it out: https://oh-my-goss.netlify.app/`;
       window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
   }

   function openThread(postId, escapedText) {
       const text = unescape(escapedText);
       const container = document.getElementById('sheetContent');
       
       // Render Thread Layout in Bottom Sheet
       container.innerHTML = `
          <div class="bs-title">Gossip Thread</div>
          <div style="background:#FFFDF0; padding:16px; border:2px solid black; margin-bottom:20px;">
             "${text}"
          </div>
          <div class="bs-title" style="font-size:16px; border:none;">Comments</div>
          <div id="bs-comments" class="comment-list">
             <div class="empty">Loading whispers...</div>
          </div>
          <textarea id="threadComment" placeholder="Add your whisper..." style="margin-bottom:8px;"></textarea>
          <button class="bs-btn" onclick="postComment('${postId}')">REPLY TO THREAD</button>
       `;
       
       document.getElementById('sheetOverlay').classList.add('active');
       document.getElementById('dynamicSheet').classList.add('active');

       // Load comments
       db.collection("townhall").doc(postId).collection("comments")
         .orderBy("createdAt", "asc")
         .onSnapshot(snap => {
             const list = document.getElementById("bs-comments");
             list.innerHTML = "";
             if(snap.empty) {
                 list.innerHTML = "<div class='empty'>No comments yet. Start the drama.</div>";
                 return;
             }
             snap.forEach(d => {
                 const c = d.data();
                 list.innerHTML += `
                    <div class="comment-item">
                        <div class="comment-meta">ANONYMOUS ¬∑ JUST NOW</div>
                        <div>${c.text}</div>
                    </div>
                 `;
             });
         });
   }

   function postComment(postId) {
       const input = document.getElementById('threadComment');
       const text = input.value.trim();
       if(!text) return;

       const batch = db.batch();
       const postRef = db.collection("townhall").doc(postId);
       const commentRef = postRef.collection("comments").doc();

       batch.set(commentRef, {
           text: text,
           createdAt: new Date()
       });
       batch.update(postRef, {
           commentCount: firebase.firestore.FieldValue.increment(1)
       });

       batch.commit().then(() => {
           input.value = "";
       });
   }


   // --- SENDING LOGIC (Unified) ---

   function handleSend() {
       if (currentTab === 'tapri') {
           sendTownhallPost();
       } else {
           sendPrivateRant();
       }
   }

   function sendTownhallPost() {
       const textEl = document.getElementById("rantText");
       const text = textEl.value.trim();
       if(!text) return;

       db.collection("townhall").add({
           text: text,
           createdAt: new Date(),
           likes: 0,
           commentCount: 0
       }).then(() => {
           textEl.value = "";
           toggleComposer();
           // Switch to tapri view to see it if not there
           if(currentTab !== 'tapri') switchTab('tapri');
       });
   }

   function sendPrivateRant() {
     const textEl = document.getElementById("rantText");
     const targetEl = document.getElementById("targetEmail");
     const text = textEl.value.trim();
     const target = targetEl.value.trim();
     const user = auth.currentUser;

     if (!text || !target || !user) return;

     db.collection("rants").add({
       from: user.email,
       to: target,
       text,
       status: "pending",
       createdAt: new Date()
     }).then(() => {
       textEl.value = "";
       targetEl.value = "";
       document.querySelector(".composer").classList.add("collapsed");
       
       // Invite logic
       checkUserExists(target).then(exists => {
         if (!exists) {
            // Show invite sheet
            document.getElementById('sheetContent').innerHTML = `
               <div class="bs-title">They aren't here yet</div>
               <div class="bs-body">This person hasn't signed up. Your whisper is pending, but they won't see it until they join.</div>
               <button class="bs-btn" onclick="sendInviteEmail('${target}')">SEND MYSTERIOUS INVITE</button>
               <button class="bs-btn-secondary" onclick="closeBottomSheet()">I'll wait for them</button>
            `;
            document.getElementById('sheetOverlay').classList.add('active');
            document.getElementById('dynamicSheet').classList.add('active');
         }
       });
     });
   }
   
   async function checkUserExists(email) {
     if (userExistenceCache[email] !== undefined) return userExistenceCache[email];
     try {
       const snap = await db.collection("users").where("email", "==", email).limit(1).get();
       const exists = !snap.empty;
       userExistenceCache[email] = exists;
       return exists;
     } catch (e) { return false; }
   }

   // --- UTILS ---
   function toggleComposer() {
     document.querySelector(".composer").classList.toggle("collapsed");
   }

   ["targetEmail", "rantText"].forEach(id => {
     document.getElementById(id).addEventListener("focus", () => {
       document.querySelector(".composer").classList.remove("collapsed");
     });
   });

   document.querySelector(".collapsed-row").addEventListener("click", () => {
     document.querySelector(".composer").classList.remove("collapsed");
   });

   function closeBottomSheet() {
     document.getElementById('sheetOverlay').classList.remove('active');
     document.getElementById('dynamicSheet').classList.remove('active');
   }

   function sendInviteEmail(target) {
     const subject = "Someone is talking about you ü§´";
     const body = `Someone just dropped a hot goss about you on Oh my Goss.\n\nIt's anonymous, it's pending, and it's waiting for you to unlock it.\n\nSee what they said before it expires:\nhttps://oh-my-goss.netlify.app/`;
     window.location.href = `mailto:${target}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
     closeBottomSheet();
   }

   function updateHotGossVisibility() {
     if (!window.__inboxReady || !window.__sentReady) return;
     const hot = document.getElementById("hotGoss");
     const countEl = document.getElementById("hotGossCount");
     const badgeEl = document.getElementById("deskBadge");
     const total = (window.__hotInboxPending || 0) + (window.__hotSentPending || 0);

     if (total > 0) {
       hot.style.display = "block";
       countEl.textContent = total + " PENDING";
       badgeEl.style.display = "inline-flex";
       badgeEl.textContent = total;
     } else {
       hot.style.display = "none";
       badgeEl.style.display = "none";
     }
   }

   // --- LOADING DESK DATA ---
   function loadSentInline(email) {
     db.collection("rants").where("from", "==", email).onSnapshot(snapshot => {
         window.__hotSentPending = 0; window.__sentReady = true;
         const container = document.getElementById("sentInline");
         container.innerHTML = "";
         const docs = snapshot.docs.sort((a, b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0));
         
         docs.forEach(doc => {
           const rant = doc.data();
           if (rant.status === "accepted") return;
           if (rant.status === "pending" || rant.status === "echoed") window.__hotSentPending++;
           
           const echoBlock = rant.echo ? `<div class="reply-box">${rant.echo}</div>` : "";
           const statusText = rant.status === "pending" ? "<span style='color:var(--accent)'>WAITING FOR REPLY</span>" : rant.status === "echoed" ? "REPLY RECEIVED" : rant.status;
           
           let actionBlock = "";
           if (rant.status === "echoed") {
               actionBlock = `<div class="action"><button onclick="acceptEchoInline('${doc.id}')">UNLOCK & START CHAT</button></div>`;
           }
           
           container.innerHTML += `
             <div class="item">
               <div class="meta">OUTGOING ¬∑ TO ${rant.to}</div>
               <div class="text">${rant.text}</div>
               <div class="status">STATUS: ${statusText}</div>
               ${echoBlock} ${actionBlock}
             </div>`;
         });
         if (!container.innerHTML) container.innerHTML = "<div class='empty'>NO OUTGOING SECRETS</div>";
         updateHotGossVisibility();
       });
   }

   function loadInboxInline(email) {
     db.collection("rants").where("to", "==", email).onSnapshot(snapshot => {
         window.__hotInboxPending = 0; window.__inboxReady = true;
         const container = document.getElementById("inboxList");
         container.innerHTML = "";
         
         if (snapshot.empty) {
           container.innerHTML = "<div class='empty'>NOTHING HOT YET</div>";
           updateHotGossVisibility(); return;
         }

         const docs = snapshot.docs.sort((a, b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0));
         docs.forEach(doc => {
           const rant = doc.data();
           if (rant.status === "accepted") return;
           if (rant.status === "pending" || rant.status === "echoed") window.__hotInboxPending++;

           let block = "";
           if (rant.status === "pending") {
             block = `<div class="prompt">ACTION REQUIRED</div>
               <textarea id="echo-${doc.id}" placeholder="Reply to unlock this chat..."></textarea>
               <div class="action"><button onclick="submitEcho('${doc.id}')">REPLY TO UNLOCK</button></div>`;
           } else if (rant.status === "echoed") {
             block = `<div class="reply-box">${rant.echo}</div><div class="status">WAITING ON SENDER TO UNLOCK</div>`;
           }

           container.innerHTML += `<div class="item"><div class="meta">INCOMING ¬∑ ANONYMOUS</div><div class="text">${rant.text}</div>${block}</div>`;
         });
         updateHotGossVisibility();
       });
   }

   function submitEcho(rantId) {
     const input = document.getElementById(`echo-${rantId}`);
     if (!input || !input.value.trim()) return;
     db.collection("rants").doc(rantId).update({ echo: input.value.trim(), status: "echoed", updatedAt: new Date() });
   }

   function acceptEchoInline(rantId) {
     const chatRef = db.collection("chats").doc();
     db.collection("rants").doc(rantId).get().then(doc => {
       const rant = doc.data();
       chatRef.set({
         users: [rant.from, rant.to], createdAt: new Date(),
         seed: [{ from: rant.from, text: rant.text, createdAt: rant.createdAt || new Date() }, { from: rant.to, text: rant.echo, createdAt: new Date() }]
       });
       db.collection("rants").doc(rantId).update({ status: "accepted", chatId: chatRef.id, updatedAt: new Date() })
         .then(() => window.location.href = `chat.html?chatId=${chatRef.id}`);
     });
   }
   
   function loadChats(userEmail) {
     db.collection("chats").where("users", "array-contains", userEmail).onSnapshot(snapshot => {
         const list = document.getElementById("chatList");
         list.innerHTML = ""; activeChats = [];
         if (snapshot.empty) { list.innerHTML = "<div class='empty'>NO FILES FOUND</div>"; return; }
         
         snapshot.forEach(doc => {
           const chat = doc.data();
           activeChats.push({ id: doc.id, createdAt: chat.createdAt });
           const peer = chat.users.find(u => u !== userEmail);
           list.innerHTML += `<div class="chat-item" onclick="openChat('${doc.id}')">
               <div class="chat-row"><div class="chat-peer">${peer}</div><div class="countdown-timer" id="timer-${doc.id}">CALCULATING...</div></div>
               <div class="chat-preview">/// ENCRYPTED - TAP TO VIEW</div></div>`;
         });
       });
   }
   function openChat(chatId) { window.location.href = `chat.html?chatId=${chatId}`; }
 </script>
</body>
</html>