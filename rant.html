<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Whisper</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Archivo:wdth,wght@100,900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg:#000;
      --fg:#fff;
      --muted:rgba(255,255,255,.65);
      --ghost:rgba(255,255,255,.45);
      --line:rgba(255,255,255,.22);
      --softbg:rgba(255,255,255,.04);
      --danger:#d40000;
    }

    * { box-sizing:border-box; }

    body {
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font-family:"JetBrains Mono", monospace;
    }

    .grain {
      position:fixed;
      inset:0;
      pointer-events:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.05'/%3E%3C/svg%3E");
    }

    .wrap {
      max-width:560px;
      margin:0 auto;
      padding:24px 18px 180px;
    }

    /* Header */
    .top h1 {
      font-family:"Archivo",sans-serif;
      font-size:32px;
      font-weight:800;
      margin:0;
    }

    .top p {
      margin-top:6px;
      font-size:12px;
      color:var(--ghost);
    }

    /* Toggle */
    .tabs {
      display:flex;
      gap:12px;
      margin-top:20px;
    }

    .tab {
      flex:1;
      background:#fff;
      color:#000;
      padding:14px;
      font-family:"Archivo",sans-serif;
      font-size:16px;
      font-weight:800;
      text-align:center;
      border-radius:6px;
      cursor:pointer;
    }

    .tab.inactive {
      opacity:.35;
    }

    /* Threads */
    .threads {
      margin-top:28px;
    }

    .thread {
      border-top:1px solid var(--line);
      padding:20px 0;
      cursor:pointer;
    }

    .thread:first-child {
      border-top:none;
    }

    .thread .meta {
      font-size:11px;
      color:var(--ghost);
      margin-bottom:6px;
    }

    .thread .text {
      font-size:14px;
      line-height:1.8;
      color:var(--muted);
    }

    .state {
      margin-top:8px;
      font-size:11px;
      color:var(--ghost);
    }

    .state.pending {
      color:var(--danger);
    }

    /* Expanded chat */
    .messages {
      margin-top:14px;
      border-top:1px dashed var(--line);
      padding-top:14px;
    }

    .message {
      margin-bottom:12px;
    }

    .from {
      font-size:11px;
      color:var(--ghost);
      margin-bottom:4px;
    }

    .msg {
      font-size:13px;
      line-height:1.7;
      color:var(--muted);
      white-space:pre-wrap;
    }

    .reply {
      margin-top:10px;
    }

    .reply textarea {
      width:100%;
      background:var(--softbg);
      border:1px solid var(--line);
      padding:12px;
      color:var(--fg);
      font-family:"JetBrains Mono",monospace;
      font-size:13px;
      resize:none;
      min-height:60px;
    }

    .reply button {
      margin-top:8px;
      width:100%;
      padding:12px;
      background:transparent;
      border:1px solid var(--line);
      color:var(--fg);
      font-size:12px;
      letter-spacing:.2em;
      text-transform:uppercase;
      cursor:pointer;
    }

    /* Composer */
    .composer {
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      background:#000;
      border-top:1px solid var(--line);
      padding:14px 18px;
    }

    .composer textarea {
      width:100%;
      background:var(--softbg);
      border:1px solid var(--line);
      padding:14px;
      color:var(--fg);
      font-size:14px;
      font-family:"JetBrains Mono",monospace;
      resize:none;
      min-height:80px;
    }

    .composer input {
      width:100%;
      margin-top:10px;
      background:transparent;
      border:none;
      border-bottom:1px solid var(--line);
      color:var(--fg);
      padding:10px 4px;
      font-size:13px;
    }

    .composer button {
      margin-top:12px;
      width:100%;
      padding:14px;
      background:transparent;
      border:1px solid var(--line);
      color:var(--fg);
      font-size:12px;
      letter-spacing:.25em;
      text-transform:uppercase;
      cursor:pointer;
    }
  </style>
</head>

<body>
<div class="grain"></div>

<div class="wrap">
  <div class="top">
    <h1>Whisper</h1>
    <p>everything that’s already being said</p>

    <div class="tabs">
      <div id="sentTab" class="tab">Sent</div>
      <div id="recvTab" class="tab inactive">Received</div>
    </div>
  </div>

  <div id="threads" class="threads"></div>
</div>

<!-- Sticky Composer -->
<div class="composer">
  <textarea id="newText" placeholder="Say it the way you remember it"></textarea>
  <input id="newTarget" placeholder="who should hear this">
  <button onclick="sendNew()">Send quietly</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyDqwklNFPF09IiE1Gh6_ckJr2Jz6F0V2f8",
  authDomain:"rant-2me.firebaseapp.com",
  projectId:"rant-2me"
};
firebase.initializeApp(firebaseConfig);

const auth=firebase.auth();
const db=firebase.firestore();

let mode="sent";
let userEmail=null;

const sentTab = document.getElementById("sentTab");
const recvTab = document.getElementById("recvTab");
const threads = document.getElementById("threads");
const newText = document.getElementById("newText");
const newTarget = document.getElementById("newTarget");

sentTab.onclick=()=>switchMode("sent");
recvTab.onclick=()=>switchMode("received");

auth.onAuthStateChanged(u=>{
  if(!u){location.href="index.html";return;}
  userEmail=u.email;
  load();
});

function switchMode(m){
  mode=m;
  sentTab.classList.toggle("inactive",m!=="sent");
  recvTab.classList.toggle("inactive",m!=="received");
  load();
}

let unsubscribe = null;
function load(){
  if(unsubscribe) unsubscribe();
  let q=db.collection("rants");
  q=mode==="sent"
    ? q.where("from","==",userEmail)
    : q.where("to","==",userEmail);

  unsubscribe = q.onSnapshot(snap=>{
    threads.innerHTML="";
    snap.forEach(d=>renderThread(d));
  });
}

function renderThread(doc){
  const r=doc.data();
  const div=document.createElement("div");
  div.className="thread";

  div.innerHTML=`
    <div class="meta">${mode==="sent"?"to":"from"} ${mode==="sent"?r.to:"anonymous"}</div>
    <div class="text">${r.text}</div>
    <div class="state ${r.status}">status · ${r.status}</div>
  `;

  div.onclick=()=>toggleChat(div,doc.id,r);
  threads.appendChild(div);
}

function toggleChat(container,id,rant){
  if(container.querySelector(".messages")) return;

  if(!rant.chatId) return;

  const box=document.createElement("div");
  box.className="messages";
  container.appendChild(box);

  db.collection("chats").doc(rant.chatId)
    .collection("messages")
    .orderBy("createdAt")
    .onSnapshot(s=>{
      box.innerHTML="";
      s.forEach(m=>{
        const d=m.data();
        box.innerHTML+=`
          <div class="message">
            <div class="from">${d.from}</div>
            <div class="msg">${d.text}</div>
          </div>`;
      });
    });
}

function sendNew(){
  const t=newText.value.trim();
  const to=newTarget.value.trim();
  if(!t||!to) return;

  db.collection("rants").add({
    from:userEmail,
    to,
    text:t,
    status:"pending",
    createdAt:new Date()
  });

  newText.value="";
  newTarget.value="";
}
</script>
</body>
</html>