<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Goss Â· Encrypted</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <link href="https://fonts.googleapis.com/css2?family=Archivo:ital,wdth,wght@0,100..900;1,100..900&family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Palette */
      --bg-color: #FFD600; /* Electric Yellow */
      --accent: #FF4800;   /* Hot Orange */
      --ink: #101010;      /* Pure Black */
      --paper: #FFFFFF;
      --me-bg: #101010;
      --me-text: #FFD600;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background-color: var(--bg-color);
      /* Subtle noise pattern */
      background-image: radial-gradient(circle at center, #FFD600 0%, #FFC107 100%);
      color: var(--ink);
      font-family: "JetBrains Mono", monospace;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden; /* Lock body, scroll chat-log */
    }

    .grain {
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.05'/%3E%3C/svg%3E");
      z-index: 0;
      mix-blend-mode: multiply;
    }

    /* --- HEADER --- */
    .top {
      flex: 0 0 auto;
      padding: 16px 20px;
      border-bottom: 4px solid var(--ink);
      background: var(--bg-color);
      z-index: 10;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 0 rgba(0,0,0,0.05);
    }

    .top-left h1 {
      font-family: "Archivo", sans-serif;
      font-size: 20px;
      font-weight: 900;
      font-style: italic;
      text-transform: uppercase;
      margin: 0;
      line-height: 1;
    }

    .top-left p {
      margin: 4px 0 0;
      font-size: 10px;
      font-weight: 700;
      background: var(--ink);
      color: var(--bg-color);
      display: inline-block;
      padding: 2px 6px;
      text-transform: uppercase;
    }

    .back-btn {
      text-decoration: none;
      font-size: 12px;
      font-weight: 800;
      color: var(--ink);
      border: 2px solid var(--ink);
      padding: 8px 12px;
      text-transform: uppercase;
      background: var(--paper);
      box-shadow: 3px 3px 0 var(--ink);
      transition: all 0.1s;
    }
    .back-btn:active {
      transform: translate(2px, 2px);
      box-shadow: 0 0 0 var(--ink);
    }

    /* --- CHAT LOG --- */
    .log {
      flex: 1 1 auto;
      overflow-y: auto;
      padding: 20px;
      padding-bottom: 40px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: relative;
      z-index: 1;
    }

    /* Message Bubbles */
    .message {
      max-width: 85%;
      padding: 14px 18px;
      position: relative;
      border: 3px solid var(--ink);
      box-shadow: 6px 6px 0 rgba(0,0,0,0.1);
      animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .message.them {
      align-self: flex-start;
      background: var(--paper);
      color: var(--ink);
    }
    
    .message.me {
      align-self: flex-end;
      background: var(--me-bg);
      color: var(--me-text);
      border-color: var(--ink);
    }

    .from {
      font-size: 10px;
      font-weight: 800;
      text-transform: uppercase;
      margin-bottom: 6px;
      letter-spacing: 0.05em;
      opacity: 0.7;
    }
    .message.me .from { color: var(--accent); opacity: 1; }

    .text {
      font-size: 14px;
      line-height: 1.5;
      font-weight: 600;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    /* --- INPUT AREA --- */
    .input-area {
      flex: 0 0 auto;
      background: var(--ink);
      border-top: 4px solid var(--accent);
      padding: 16px;
      z-index: 20;
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    .input-area textarea {
      flex: 1;
      background: var(--paper);
      border: 2px solid var(--ink);
      padding: 12px;
      color: var(--ink);
      font-family: "JetBrains Mono", monospace;
      font-size: 14px;
      resize: none;
      min-height: 50px;
      max-height: 120px;
      outline: none;
    }
    .input-area textarea:focus {
      background: #FFFDF0;
      border-color: var(--accent);
    }

    .send-btn {
      width: 70px;
      height: 50px;
      background: var(--bg-color);
      border: 2px solid var(--paper);
      color: var(--ink);
      font-family: "Archivo", sans-serif;
      font-weight: 900;
      font-size: 14px;
      text-transform: uppercase;
      cursor: pointer;
      box-shadow: 4px 4px 0 var(--accent);
      transition: all 0.1s;
    }
    .send-btn:active {
      transform: translate(2px, 2px);
      box-shadow: 0 0 0 var(--accent);
    }

    @keyframes popIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    
    /* Scrollbar styling */
    .log::-webkit-scrollbar { width: 6px; }
    .log::-webkit-scrollbar-track { background: transparent; }
    .log::-webkit-scrollbar-thumb { background: var(--ink); border-radius: 3px; }

  </style>
</head>

<body>
  <div class="grain"></div>

  <div class="top">
    <div class="top-left">
      <h1>Confidential</h1>
      <p>Secure Line</p>
    </div>
    <a href="rant.html" class="back-btn">Exit</a>
  </div>

  <div id="messages" class="log">
    </div>

  <div class="input-area">
    <textarea id="msg" placeholder="Add to the record..."></textarea>
    <button class="send-btn" onclick="send()">Send</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDqwklNFPF09IiE1Gh6_ckJr2Jz6F0V2f8",
      authDomain: "rant-2me.firebaseapp.com",
      projectId: "rant-2me"
    };

    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.firestore();

    const params = new URLSearchParams(window.location.search);
    const chatId = params.get("chatId");

    auth.onAuthStateChanged(user => {
      if (!user || !chatId) {
        window.location.href = "index.html";
        return;
      }

      db.collection("chats").doc(chatId).get().then(doc => {
        if (!doc.exists || !doc.data().users.includes(user.email)) {
          alert("ACCESS DENIED");
          window.location.href = "rant.html";
          return;
        }

        const chat = doc.data();

        // Hydrate seed logic (Exactly as requested)
        if (chat.seed && Array.isArray(chat.seed)) {
          db.collection("chats")
            .doc(chatId)
            .collection("messages")
            .limit(1)
            .get()
            .then(snapshot => {
              if (!snapshot.empty) return;

              const batch = db.batch();
              chat.seed.forEach(m => {
                const ref = db.collection("chats")
                  .doc(chatId)
                  .collection("messages")
                  .doc();
                batch.set(ref, {
                  from: m.from,
                  text: m.text,
                  createdAt: m.createdAt || new Date()
                });
              });
              batch.commit();
            });
        }

        // Real-time listener
        db.collection("chats")
          .doc(chatId)
          .collection("messages")
          .orderBy("createdAt")
          .onSnapshot(snapshot => {
            const container = document.getElementById("messages");
            container.innerHTML = "";

            snapshot.forEach(doc => {
              const m = doc.data();
              // Determine class based on sender
              const isMe = m.from === user.email;
              const typeClass = isMe ? "me" : "them";
              const fromLabel = isMe ? "YOU" : m.from;

              container.innerHTML += `
                <div class="message ${typeClass}">
                  <div class="from">${fromLabel}</div>
                  <div class="text">${m.text}</div>
                </div>
              `;
            });
            
            // Auto-scroll to bottom
            container.scrollTop = container.scrollHeight;
          });
      });
    });

    function send() {
      const user = auth.currentUser;
      const input = document.getElementById("msg");
      const text = input.value.trim();

      if (!text) return;

      db.collection("chats")
        .doc(chatId)
        .collection("messages")
        .add({
          from: user.email,
          text,
          createdAt: new Date()
        });

      input.value = "";
    }
    
    // Allow Enter key to send
    document.getElementById("msg").addEventListener("keydown", function(e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });
  </script>
</body>
</html>