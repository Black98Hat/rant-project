<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Goss · Encrypted</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <link href="https://fonts.googleapis.com/css2?family=Archivo:ital,wdth,wght@0,100..900;1,100..900&family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Palette */
      --bg-color: #FFD600; /* Electric Yellow */
      --accent: #FF4800;   /* Hot Orange */
      --ink: #101010;      /* Pure Black */
      --paper: #FFFFFF;
      --me-bg: #101010;
      --me-text: #FFD600;
      --danger: #FF003C;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      background-color: var(--bg-color);
      background-image: radial-gradient(circle at center, #FFD600 0%, #FFC107 100%);
      color: var(--ink);
      font-family: "JetBrains Mono", monospace;
      height: 100dvh; 
      display: flex;
      flex-direction: column;
      overflow: hidden; 
    }

    .grain {
      position: fixed; inset: 0; pointer-events: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.05'/%3E%3C/svg%3E");
      z-index: 0; mix-blend-mode: multiply;
    }

    /* --- HEADER --- */
    .top {
      flex: 0 0 auto; background: var(--bg-color); border-bottom: 4px solid var(--ink);
      padding: 12px 16px; z-index: 10; display: grid; grid-template-columns: 1fr auto 1fr;
      align-items: center; gap: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .nuke-btn {
      background: var(--danger); color: white; border: 2px solid var(--ink);
      font-family: "Archivo", sans-serif; font-weight: 900; font-size: 12px;
      padding: 8px 12px; text-transform: uppercase; box-shadow: 3px 3px 0 var(--ink);
      cursor: pointer; display: flex; align-items: center; gap: 4px; white-space: nowrap;
    }
    .nuke-btn:active { transform: translate(2px, 2px); box-shadow: none; }

    .timer-display {
      text-align: center; font-family: "Archivo", sans-serif; font-weight: 900;
      font-size: 20px; font-style: italic; color: var(--ink); border: 2px solid var(--ink);
      background: var(--paper); padding: 4px 12px; min-width: 80px;
    }

    .back-btn {
      justify-self: end; text-decoration: none; font-size: 11px; font-weight: 800;
      color: var(--ink); text-transform: uppercase; border-bottom: 2px solid var(--ink);
    }

    /* --- MARQUEE --- */
    .participants-marquee {
      background: var(--ink); color: var(--bg-color); font-size: 10px; font-weight: 700;
      padding: 4px 0; white-space: nowrap; overflow: hidden; text-transform: uppercase; flex: 0 0 auto;
    }
    .marquee-content {
      display: inline-block; padding-left: 100%; animation: scroll-left 15s linear infinite;
    }
    @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

    /* --- CHAT LOG --- */
    .log {
      flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column;
      gap: 16px; position: relative; z-index: 1; scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch; padding-bottom: 20px;
    }

    .message {
      max-width: 85%; padding: 12px 16px; position: relative;
      border: 3px solid var(--ink); box-shadow: 6px 6px 0 rgba(0,0,0,0.1);
      animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .message.them { align-self: flex-start; background: var(--paper); color: var(--ink); }
    .message.me { align-self: flex-end; background: var(--me-bg); color: var(--me-text); border-color: var(--ink); }
    
    .from { font-size: 9px; font-weight: 800; text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.05em; opacity: 0.7; }
    .message.me .from { color: var(--accent); opacity: 1; }
    .text { font-size: 14px; line-height: 1.4; font-weight: 600; white-space: pre-wrap; word-wrap: break-word; }

    /* --- INPUT AREA --- */
    .input-area {
      flex: 0 0 auto; background: var(--ink); border-top: 4px solid var(--accent);
      padding: 12px 16px; z-index: 999; display: flex; gap: 12px; align-items: flex-end;
      padding-bottom: max(12px, env(safe-area-inset-bottom)); box-shadow: 0 -4px 10px rgba(0,0,0,0.2);
    }
    .input-area textarea {
      flex: 1; background: var(--paper); border: 2px solid var(--ink); padding: 12px;
      color: var(--ink); font-family: "JetBrains Mono", monospace; font-size: 16px;
      resize: none; height: 50px; outline: none; border-radius: 0;
    }
    .input-area textarea:focus { background: #FFFDF0; border-color: var(--accent); }

    .send-btn {
      width: 60px; height: 50px; background: var(--bg-color); border: 2px solid var(--paper);
      color: var(--ink); font-family: "Archivo", sans-serif; font-weight: 900; font-size: 12px;
      text-transform: uppercase; cursor: pointer; box-shadow: 4px 4px 0 var(--accent); flex-shrink: 0;
    }
    .send-btn:active { transform: translate(2px, 2px); box-shadow: none; }

    @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

    /* --- NUKE UI --- */
    .overlay {
      position: fixed; inset: 0; background: rgba(16, 16, 16, 0.9);
      backdrop-filter: blur(4px); z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .overlay.active { opacity: 1; pointer-events: auto; }

    .bottom-sheet {
      position: fixed; left: 0; right: 0; bottom: -100%; background: var(--bg-color);
      border-top: 4px solid var(--ink); padding: 32px 24px 48px; z-index: 2001;
      transition: bottom 0.3s cubic-bezier(0.19, 1, 0.22, 1); box-shadow: 0 -20px 50px rgba(0,0,0,0.5);
    }
    .bottom-sheet.active { bottom: 0; }

    .bs-title { font-family: "Archivo", sans-serif; font-size: 24px; font-weight: 900; font-style: italic; text-transform: uppercase; margin-bottom: 12px; color: var(--danger); }
    .bs-text { font-size: 14px; font-weight: 600; margin-bottom: 24px; line-height: 1.5; }

    .bs-btn-danger {
      width: 100%; padding: 16px; background: var(--danger); color: white; border: 3px solid var(--ink);
      font-weight: 800; font-family: "Archivo", sans-serif; text-transform: uppercase;
      box-shadow: 4px 4px 0 var(--ink); cursor: pointer;
    }
    .bs-btn-danger:active { transform: translate(2px, 2px); box-shadow: none; }

    .bs-btn-cancel {
      width: 100%; background: transparent; border: none; padding: 12px;
      text-decoration: underline; font-weight: 700; cursor: pointer; margin-top: 8px;
    }
    .waiting-box {
      border: 2px dashed var(--ink); padding: 16px; text-align: center;
      background: rgba(255,255,255,0.5); font-weight: 700; font-size: 12px;
    }
  </style>
</head>

<body>
  <div class="grain"></div>

  <div class="top">
    <button class="nuke-btn" onclick="initiateNuke()">☢️ NUKE</button>
    <div class="timer-display" id="timer">--:--</div>
    <a href="rant.html" class="back-btn">Exit</a>
  </div>

  <div class="participants-marquee">
    <div class="marquee-content" id="participantsText">LOADING SECURE CONNECTION...</div>
  </div>

  <div id="messages" class="log"></div>

  <div class="input-area">
    <textarea id="msg" placeholder="Add to the record..." autofocus></textarea>
    <button class="send-btn" onclick="send()">Send</button>
  </div>

  <div class="overlay" id="sheetOverlay"></div>
  <div class="bottom-sheet" id="nukeSheet"></div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const CHAT_TTL_MINUTES = 15;
    const firebaseConfig = {
      apiKey: "AIzaSyDqwklNFPF09IiE1Gh6_ckJr2Jz6F0V2f8", 
      authDomain: "rant-2me.firebaseapp.com",
      projectId: "rant-2me"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const params = new URLSearchParams(window.location.search);
    const chatId = params.get("chatId");
    
    // Global State for efficiency
    let currentChatData = null; 
    let timerInterval = null;

    // Force focus logic
    window.onload = function() {
        setTimeout(() => {
            const input = document.getElementById("msg");
            if(input) input.focus();
        }, 500);
    };

    auth.onAuthStateChanged(user => {
      if (!user || !chatId) {
        window.location.href = "index.html";
        return;
      }

      // 1. Listen to Chat Metadata
      db.collection("chats").doc(chatId).onSnapshot(doc => {
        // --- KEY DESTRUCTION CHECK ---
        if (!doc.exists) {
          // Chat deleted by nuke confirmation. Redirect immediately.
          window.location.href = "rant.html";
          return;
        }

        const chat = doc.data();
        currentChatData = chat; // Update global state

        // Security Check
        if (!chat.users.includes(user.email)) {
          window.location.href = "rant.html"; return;
        }

        // UI Updates
        document.getElementById("participantsText").innerText = 
          `SECURE CONNECTION: ${chat.users.join('  <->  ')}   ///   ENCRYPTED`;

        startTimer(chat.createdAt);
        handleNukeState(chat, user.email);

        // One-time Seed
        if (chat.seed) hydrateSeed(chat);
      });

      // 2. Listen to Messages
      db.collection("chats").doc(chatId).collection("messages")
        .orderBy("createdAt")
        .onSnapshot(snapshot => {
          const container = document.getElementById("messages");
          // Efficient DOM update: clear and rebuild is fine for small chats, 
          // allows exact sync with DB state
          container.innerHTML = "";
          
          snapshot.forEach(doc => {
            const m = doc.data();
            const isMe = m.from === user.email;
            container.innerHTML += `
              <div class="message ${isMe ? "me" : "them"}">
                <div class="from">${isMe ? "YOU" : "THEY"}</div>
                <div class="text">${m.text}</div>
              </div>
            `;
          });
          container.scrollTop = container.scrollHeight;
        });
    });

    // --- LOGIC ---

    function hydrateSeed(chat) {
       // Only run if empty to avoid infinite writes if seed fails to delete
       db.collection("chats").doc(chatId).collection("messages").limit(1).get().then(snap => {
         if(snap.empty && chat.seed) {
           const batch = db.batch();
           chat.seed.forEach(m => {
             const ref = db.collection("chats").doc(chatId).collection("messages").doc();
             batch.set(ref, { from: m.from, text: m.text, createdAt: m.createdAt });
           });
           batch.update(db.collection("chats").doc(chatId), { seed: firebase.firestore.FieldValue.delete() });
           batch.commit();
         }
       });
    }

    function startTimer(timestamp) {
      if(!timestamp) return;
      if(timerInterval) clearInterval(timerInterval); // Prevent memory leaks

      const update = () => {
        const now = new Date();
        const created = timestamp.toDate();
        const expires = new Date(created.getTime() + CHAT_TTL_MINUTES * 60000);
        const diff = expires - now;

        if (diff <= 0) {
          clearInterval(timerInterval);
          document.getElementById("timer").innerText = "00:00";
        } else {
          const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          const secs = Math.floor((diff % (1000 * 60)) / 1000);
          document.getElementById("timer").innerText = 
            `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
      };
      
      update(); // Run immediately
      timerInterval = setInterval(update, 1000);
    }

    // --- NUKE LOGIC (OPTIMIZED) ---

    function handleNukeState(chat, myEmail) {
      const sheet = document.getElementById("nukeSheet");
      const overlay = document.getElementById("sheetOverlay");
      
      if (chat.nukeRequest) {
        // Active Nuke Request found in DB
        overlay.classList.add("active");
        sheet.classList.add("active");

        if (chat.nukeRequest === myEmail) {
          // I AM THE SENDER
          sheet.innerHTML = `
            <div class="bs-title">AWAITING CONFIRMATION</div>
            <div class="bs-text">
              You have armed the destruction sequence. Waiting for the other person to turn their key.
            </div>
            <div class="waiting-box">WAITING FOR PARTNER...</div>
            <button class="bs-btn-cancel" onclick="cancelNuke()">CANCEL REQUEST</button>
          `;
        } else {
          // I AM THE RECEIVER -> ACTION REQUIRED
          sheet.innerHTML = `
            <div class="bs-title">⚠️ DESTRUCTION REQUEST</div>
            <div class="bs-text">
              Your partner wants to nuke this chat. If you agree, all records will be permanently erased immediately.
            </div>
            <button class="bs-btn-danger" onclick="confirmDestruction()">AGREE & DESTROY</button>
            <button class="bs-btn-cancel" onclick="cancelNuke()">REJECT</button>
          `;
        }
      } else {
        // If we are locally showing the "Initiate?" prompt, don't close it. 
        // Only close if we are not in the "initiating" phase locally.
        // We detect this by checking if the sheet has specific DB-related content classes.
        // But simpler: If the sheet was showing a DB state (Waiting/Request), close it.
        const content = sheet.innerHTML;
        if (content.includes("AWAITING") || content.includes("DESTRUCTION REQUEST")) {
            overlay.classList.remove("active");
            sheet.classList.remove("active");
        }
      }
    }

    function initiateNuke() {
      // Use cached data to avoid network latency
      if(!currentChatData) return;

      const myEmail = auth.currentUser.email;
      const distinctUsers = [...new Set(currentChatData.users)];

      if(distinctUsers.length === 1 && distinctUsers[0] === myEmail) {
          // Self Chat: Instant Kill
          confirmDestruction();
      } else {
          // Real Chat: Show Local Prompt
          const sheet = document.getElementById("nukeSheet");
          const overlay = document.getElementById("sheetOverlay");
          
          sheet.innerHTML = `
            <div class="bs-title">INITIATE DESTRUCTION?</div>
            <div class="bs-text">
              This sends a request to your partner. If they agree, this chat vanishes for both of you instantly.
            </div>
            <button class="bs-btn-danger" onclick="sendNukeRequest()">SEND DESTRUCT SIGNAL</button>
            <button class="bs-btn-cancel" onclick="closeSheet()">NEVER MIND</button>
          `;
          
          overlay.classList.add("active");
          sheet.classList.add("active");
      }
    }

    function closeSheet() {
      document.getElementById("sheetOverlay").classList.remove("active");
      document.getElementById("nukeSheet").classList.remove("active");
    }

    function sendNukeRequest() {
      // Updates DB -> Triggers onSnapshot -> Updates UI to "Waiting"
      db.collection("chats").doc(chatId).update({
        nukeRequest: auth.currentUser.email
      });
    }

    function cancelNuke() {
      // Handles both "Cancel" (Sender) and "Reject" (Receiver)
      db.collection("chats").doc(chatId).update({
        nukeRequest: firebase.firestore.FieldValue.delete()
      });
      closeSheet();
    }

    function confirmDestruction() {
      console.log("Attempting to delete chat: " + chatId);
      
      db.collection("chats").doc(chatId).delete()
        .then(() => {
           console.log("Document successfully deleted!");
           // The onSnapshot listener handles the redirect
        })
        .catch((error) => {
           console.error("Error removing document: ", error);
           alert("NUKE FAILED: " + error.message); // This will tell us the exact reason
        });
    }

    // --- MESSAGING ---

    function send() {
      const input = document.getElementById("msg");
      const text = input.value.trim();
      if (!text) return;

      db.collection("chats").doc(chatId).collection("messages").add({
        from: auth.currentUser.email,
        text,
        createdAt: new Date()
      });
      input.value = "";
      input.focus();
    }

    document.getElementById("msg").addEventListener("keydown", function(e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

  </script>
</body>
</html>